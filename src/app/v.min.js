export class V{constructor(a){a||(a={}),this.logging=a.logging,this.root=a.root?this.el(a.root):window.document,this.log('Root configured to be: ',this.root),this.selector='data-',a.namespace?(this.namespace=a.namespace,this.selector+=a.namespace+'-'):(this.namespace='v',this.selector+='v-'),this.log('Namespace: '+this.namespace),this.log('Selector: '+this.selector),this.app=a.app?a.app:window,this.log('App object: ',this.app),a.start&&(this.start=a.start,this.log('Start page: ',this.start)),this.activePage=null,this.init()}log(a,b){this.logging&&(b?console.debug('v.js: '+a,b):console.debug('v.js: '+a))}error(a,b){b?console.error('v.js error: '+a,b):console.error('v.js error: '+a)}att(a,b,c=void 0){if(!b)debugger;return void 0===c?b.getAttribute(this.selector+a):void(null===c?b.removeAttribute(this.select+a):b.setAttribute(this.select+a,c))}el(a){return'string'==typeof a?document.getElementById(a):a}elements(a,b=this.root){return b.querySelectorAll('['+this.selector+a+']')}style(a,b,c){a.style[b]=c}hide(a){var b=this.el(a);b&&this.style(b,'display','none')}show(a,b){var c=this.el(a);b||(b='inline-block'),c&&this.style(c,'display',b)}page(a){var b=this;b.hide(b.activePage);var c=b.elements('page');return c.forEach(f=>{var g=b.att('page',f);if(g){var h=g.split('|');if(0<h.length){var j=h[0];if(j==a)return void(b.activePage=f)}}}),b.activePage?void(b.show(b.activePage),b.initPage(b.activePage,()=>{var g=b.att('opened',b.activePage);if(g){var h=b.call(g,{},b.activePage);h&&'Promise'===h.constructor.name?h.then(j=>{b.bind(b.activePage,j)}):b.bind(b.activePage,h)}})):void b.error('Unable to find a corresponding page for the action. Page name: '+a)}sanitizeDataSelector(a){return a.split('-').join('.')}bind(a,b){for(var c=this,d=c.elements('bind',a),f=0;f<d.length;f++){var g=d[f],h=c.att('bind',g);if(null!==h){var j=c.getData(b,c.sanitizeDataSelector(h));if(void 0===j&&(j=null),'INPUT'===g.nodeName)g.value=j;else if('SELECT'!==g.nodeName)g.innerHTML=j;else if(g.innerHTML='','Array'===j.constructor.name)for(var f=0;f<j.length;f++){var l=j[f],m=document.createElement('option');void 0===l.label?(m.value=l,m.innerText=l):(m.value=l.value,m.innerText=l.label),g.appendChild(m)}else{var m=document.createElement('option');m.value=j,m.innerText=j,g.appendChild(m)}}}var n=c.elements('list',a);n.forEach(o=>{var p=c.att('list',o).split('|');if(2!=p.length)throw new Error('The list binding must include item name and array name, separated by an pipe ("|")');var q=b[p[1]],r=c.elements('item',o),s=[];r.forEach(u=>{var v=c.att('item',u);s.push({key:v,element:u})});var t=c.elements('item-action',o);q.forEach(u=>{for(var v in u)if(u.hasOwnProperty(v)){var x=u[v],y=s.filter(z=>z.key===v);y.forEach(z=>{z.element.innerHTML=x})}t.forEach(z=>{z.addEventListener('click',A=>{c.call(c.att('item-action',z),A,A.srceElement,u)})})})})}getData(a,b){if('undefined'!=typeof a){var c=b.indexOf('.');return-1<c?this.getData(a[b.substring(0,c)],b.substr(c+1)):a[b]}}setData(a,b,c){if('undefined'!=typeof a){var d=b.indexOf('.');return-1<d?(void 0===a[b.substring(0,d)]&&(a[b.substring(0,d)]={}),this.setData(a[b.substring(0,d)],b.substr(d+1),c)):void(a[b]=c)}}call(a,b,c,d){if('eval'===a.toLowerCase())return void this.log('What are you trying to do?');var f=this.app[a];return f?(this.log('Calling: '+a),f(this,b,c,d)):void this.log('Handler not defined for: '+a)}download(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4==this.readyState&&200==this.status&&b(c.responseText)},c.open('GET',a,!0),c.send()}onAction(a,b){this.call(this.att('action',a.srcElement),a,a.srcElement,b)}findAttribute(a){if(!a)return null;var c=this.att('open',a);return c?c:this.findAttribute(a.parentElement)}onPage(a){var b=this.findAttribute(a.srcElement);this.page(b)}initPage(a,b){var c=this;if(a){c.show(a);var d=null,f=c.att('page',a);if(f){var g=f.split('|');console.log(g),1<g.length&&(d=g[1].trim())}if(this.activePage=a,d)this.download(d,l=>{var m=this.att('page',a);a.setAttribute(this.selector+'page',m.replace(d,'')),a.innerHTML=l,c.initPage(a,b)});else{var h=c.elements('action');h.forEach(l=>{'true'===c.att('init',l)||(l.addEventListener('click',m=>{var n=null;if(m.srcElement.form){var o=m.srcElement.form.getElementsByTagName('input'),p=m.srcElement.form.getElementsByTagName('select');n={};for(var r,q=0;q<o.length;q++)if(r=o[q],''!==r.name){var s=this.sanitizeDataSelector(r.name),t=r.value;this.setData(n,s,t),r.value=null}for(var u,q=0;q<p.length;q++)if(u=p[q],''!==u.name){var s=this.sanitizeDataSelector(u.name),t=u.value;this.setData(n,s,t)}}c.onAction(m,n)}),c.att('init',l,'true'))});var j=this.elements('open');j.forEach(l=>{'true'===c.att('init',l)||(l.addEventListener('click',m=>{c.onPage(m)}),c.att('init',l,'true'))}),b()}}}hidePages(){var a=this,b=this.elements('page');return b.forEach(c=>{a.hide(c)}),b}init(){var a=this;this.call('onStart');var b=this.hidePages(),c=null;this.start?(c=document.getElementById(this.start),!c&&a.error('Unable to find the specified start page.')):0<b.length?c=b[0]:c=this.root,this.initPage(c,()=>{this.call('onStarted')}),window.onbeforeunload=function(){a.call('onEnd')}}}